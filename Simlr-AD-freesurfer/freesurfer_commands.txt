## Start with the following
source /etc/profile.d/lmod.sh
source /etc/profile.d/easybuild.sh
export FREESURFER_HOME=/homedtic/gmarti/LIB/freesurfer
. $FREESURFER_HOME/SetUpFreeSurfer.sh
export SUBJECTS_DIR=/homedtic/gmarti/DATA/Data/SIMLR-AD-FS_Full/
module load libGLU

## Execute mri_prepoc

# Depining on which problem we want, change. We start with thickness

mris_preproc --fsgd freefiles/adni_files.fsgd \
  --cache-in thickness.fwhm10.fsaverage \
  --target fsaverage \
  --hemi lh \
  --out processed_files/lh.adni_files_1.thickness.10.mgh

mris_preproc --fsgd freefiles/adni_files.fsgd \
  --cache-in volume.fwhm10.fsaverage \
  --target fsaverage \
  --hemi lh \
  --out processed_files/lh.adni_files.volume.10.mgh

Do GLM ANalysis:
mri_glmfit \
  --y processed_files/lh.adni_files.thickness.10.mgh \
  --fsgd freefiles/adni_files.fsgd dods\
  --C freefiles/C4MCI.mtx \
  --surf fsaverage lh \
  --cortex \
  --glmdir glm_output/lh.C4MCI.glmdir

  mri_glmfit \
    --y processed_files/lh.adni_files.volume.10.mgh \
    --fsgd freefiles/adni_files.fsgd dods\
    --C freefiles/C4MCI.mtx \
    --surf fsaverage lh \
    --glmdir glm_output/lh.C4MCIvol.glmdir

# Description of the output directory
beta.mgh -- all parameter estimates (surface overlay)
dof.dat  -- degrees of freedom (text)
fwhm.dat -- average FWHM of residual (text)
lh-Avg-thickness-age-Cor -- contrast subdirectory
mask.mgh -- binary mask (surface overlay)
mri_glmfit.log -- log file (text, send this with bug reports)
rstd.mgh -- residual standard deviation (surface overlay)
rvar.mgh -- residual variance (surface overlay)
sar1.mgh -- residual spatial AR1  (surface overlay)
surface -- the subject and hemisphere used for this analysis (text)
Xg.dat -- design matrix  (text)
X.mat -- design matrix (MATLAB format)
y.fsgd -- copy of input FSGD file  (text)

There will be a subdirectory for each contrast that you specify. The name of the directory will be that of the contrast matrix file (without the .mtx extension). For example, to inspect the lh-Avg-thickness-age-Cor directory, run

ls lh.gender_age.glmdir/lh-Avg-thickness-age-Cor

and you will see the following files:

C.dat -- original contrast matrix (text)
cnr.mgh -- contrast-to-noise ratio (surface overlay)
efficiency.dat -- statistical efficiency for the contrast (text)
F.mgh -- F ratio of contrast  (surface overlay)
gamma.mgh -- contrast effect size (surface overlay)
gammavar.mgh --contrast variance (surface overlay)
maxvox.dat -- voxel with the maximum statistic (text)
pcc.mgh -- partial (pearson) correlation coefficient (surface overlay)
sig.mgh -- significance, -log10(pvalue), uncorrected (surface overlay)
z.mgh -- z-stat that corresponds to the significance (surface overlay)

View the uncorrected significance map with freeview. First, make sure you are in the correct directory:

cd $SUBJECTS_DIR/glm

Then, run this command to visualize the data:

freeview -f $SUBJECTS_DIR/fsaverage/surf/lh.inflated:annot=aparc.annot:annot_outline=1:overlay=glm_output/lh.C4MCI.glmdir/C4MCI/sig.mgh:overlay_threshold=1.3 -viewport 3d

Try clustering iteration

mri_glmfit-sim \
  --glmdir glm_output/lh.C4CN.glmdir \
  --cache 2 abs \
  --cwp  0.05\
  --2spaces

visualize

freeview -f $SUBJECTS_DIR/fsaverage/surf/lh.inflated:overlay=glm_output/lh.C4CN.glmdir/C4CN/cache.th40.neg.sig.cluster.mgh:overlay_threshold=2,5:annot=glm_output/lh.C4CN.glmdir/C4CN/cache.th40.neg.sig.ocn.annot -viewport 3d
